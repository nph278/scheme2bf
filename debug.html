<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>BF Simulator</title>
    <style>
      html {
          background: #202040;
      }

      pre {
          display: block;
          background: #000000;
          color: #ffffff;
          padding: 1em;
          font-size: 150%;
      }

      pre strong {
          background: #f01040;
          color: #000000;
      }
    </style>
  </head>
  <body>
    <textarea id="code_input"></textarea>
    <textarea id="text_input"></textarea>
    <p id="buttons">
      <button id="reset">reset</button>
      <button id="step">step</button>
      <button id="back">back</button>
      <button id="run">run</button>
      <button id="stop">stop</button>
      <button id="save">save</button>
      <button id="load">load</button>
    </p>
    <pre id="code_display"></pre>
    <pre id="data_display"></pre>
    <pre id="output_display"></pre>
    <script>
      window.onload = () => {
          const history_limit = 10;
          const code_input = document.getElementById("code_input");
          const text_input = document.getElementById("text_input");
          const code_display = document.getElementById("code_display");
          const data_display = document.getElementById("data_display");
          const output_display = document.getElementById("output_display");

          let save = null;
          let history = [];
          let state; 
          let running;

          const reset = () => {
              state = {node: parse(code_input.value), data: [0], data_pos: 0, output: ""};
              running = false;

              console.log(state);
              update();
          }

          const update = () => {
              const s = sanitized_code();

              code_display.innerHTML = s;

              let d = state.data.map(n => {
                  const a = n.toString();
                  if (a.length === 3) {
                      return a;
                  } else if (a.length === 2) {
                      return "0" + a;
                  } else {
                      return "00" + a;
                  }
              });
              d[state.data_pos] = "<strong>" + d[state.data_pos] + "</strong>";

              data_display.innerHTML = d.join(" ");

              output_display.innerText = state.output;
          }

          const parse = (s) => {
              let tokens = [];
              let string_pos = 0;
              while (s.length > string_pos) {
                  const c = s[string_pos];
                  if ("+-<>[],.".includes(c)) {
                      tokens.push({token: c, pos: string_pos});
                  }
                  string_pos++;
              }
              console.log(Array.from(tokens));

              const children = parse_inner(tokens);
              const parent = {type: "]", pos: -1, children, index: 0};
              for (let i = 0; i < children.length; i++) {
                  children[i].parent = parent;
              }
              return parent;
          }

          const parse_inner = (tokens) => {
              let nodes = [];
              while (tokens.length > 0 && tokens[0].token !== "]") {
                  const t = tokens.shift();
                  if (t.token === "[") {
                      const children = parse_inner(tokens);
                      const parent = {type: "[", pos: t.pos, children, index: 0};
                      nodes.push(parent);
                      for (let i = 0; i < children.length; i++) {
                          children[i].parent = parent;
                      }
                      tokens.shift();
                  } else {
                      nodes.push({type: t.token, pos: t.pos});
                  }
              }
              return nodes;
          }

          const sanitized_code = () => {
              return code_input.value.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
          }

          const next_node = () => {
              while (true) {
                  if ("children" in state.node && state.node.index < state.node.children.length) {
                      state.node = state.node.children[state.node.index];
                      return;
                  } else if (state.node.type === "]") {
                      return;
                  } else {
                      state.node = state.node.parent;
                      state.node.index++;
                  }
              }
          }

          const step = () => {
              history.push(structuredClone(state));
              if (history.length > history_limit) {
                  history.shift();
              }

              if (state.node.type === "]") {
                  if (state.node.index < state.node.children.length) {
                      state.node = state.node.children[state.node.index];
                  }
              } else if (state.node.type === "+") {
                  state.data[state.data_pos]++;
                  state.data[state.data_pos] %= 256;
                  next_node();
              } else if (state.node.type === "-") {
                  state.data[state.data_pos] += 255;
                  state.data[state.data_pos] %= 256;
                  next_node();
              } else if (state.node.type === "<") {
                  state.data_pos--;
                  next_node();
              } else if (state.node.type === ">") {
                  state.data_pos++;
                  if (state.data_pos === state.data.length) {
                      state.data.push(0);
                  }
                  next_node();
              }

              update();
          }

          reset();
          document.getElementById("reset").onclick = reset;
          document.getElementById("step").onclick = step;
      }
    </script>
  </body>
</html>
